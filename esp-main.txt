local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")


local FUNCTION = "EXECUTE_ESP_HACK" 
local EXCLUDE_LOCALPLAYER = true 
local ShowDistance = true
local PANEL_SIZE = UDim2.new(0, 320, 0, 400)
local HEADER_HEIGHT = 36


local C_Background = Color3.fromRGB(35, 37, 40) 
local C_Background_Lighter = Color3.fromRGB(44, 46, 51) 
local C_Background_Lightest = Color3.fromRGB(54, 57, 63) 
local C_Primary = Color3.fromRGB(0, 162, 255) 
local C_Primary_Dark = Color3.fromRGB(0, 130, 200)
local C_Text = Color3.fromRGB(240, 240, 240) 
local C_Text_Dim = Color3.fromRGB(180, 180, 180) 
local C_Text_Dark = Color3.fromRGB(20, 20, 20)
local C_Success = Color3.fromRGB(80, 220, 120) 
local C_Error = Color3.fromRGB(255, 80, 80) 
local C_Teal = Color3.fromRGB(0, 200, 200) 


local ESPs = {} 
local ESPEnabled = {} 
local viewAllEnabled = false
local UI = {} 


local function norm(s)
	return (s and tostring(s) or ""):lower()
end

local function tryCopyToClipboard(text)
	local ok, err = pcall(function() setclipboard(text) end)
	return ok
end


local function createButton(name, text, parent)
	local btn = Instance.new("TextButton")
	btn.Name = name
	btn.Text = text
	btn.Parent = parent
	btn.BackgroundColor3 = C_Primary
	btn.TextColor3 = C_Text
	btn.Font = Enum.Font.SourceSansBold
	btn.TextSize = 16
	btn.BorderSizePixel = 0
	
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 6)
	corner.Parent = btn
	
	
	btn.MouseEnter:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = C_Primary_Dark}):Play()
	end)
	btn.MouseLeave:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = C_Primary}):Play()
	end)
	
	return btn
end


local function createGUI()
	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "ModernESPUI_v2"
	screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	screenGui.ResetOnSpawn = false
	
	
	local overlay = Instance.new("Frame")
	overlay.Name = "PasswordOverlay"
	overlay.Size = UDim2.new(1,0,1,0)
	overlay.Position = UDim2.new(0,0,0,0)
	overlay.BackgroundColor3 = Color3.fromRGB(0,0,0)
	overlay.BackgroundTransparency = 0.5
	overlay.ZIndex = 10
	overlay.Parent = screenGui
	UI.PasswordOverlay = overlay

	local modal = Instance.new("Frame")
	modal.Name = "Modal"
	modal.Size = UDim2.new(0, 360, 0, 220)
	modal.Position = UDim2.new(0.5, -180, 0.5, -110)
	modal.BackgroundColor3 = C_Background
	modal.BorderSizePixel = 0
	modal.Parent = overlay
	
	local modalCorner = Instance.new("UICorner")
	modalCorner.CornerRadius = UDim.new(0, 8)
	modalCorner.Parent = modal
	
	local modalPadding = Instance.new("UIPadding")
	modalPadding.PaddingLeft = UDim.new(0, 16)
	modalPadding.PaddingRight = UDim.new(0, 16)
	modalPadding.PaddingTop = UDim.new(0, 16)
	modalPadding.PaddingBottom = UDim.new(0, 16)
	modalPadding.Parent = modal

	local modalTitle = Instance.new("TextLabel")
	modalTitle.Name = "Title"
	modalTitle.Size = UDim2.new(1, 0, 0, 30)
	modalTitle.BackgroundTransparency = 1
	modalTitle.Text = "Panel Authentication"
	modalTitle.Font = Enum.Font.SourceSansBold
	modalTitle.TextSize = 20
	modalTitle.TextColor3 = C_Text
	modalTitle.TextXAlignment = Enum.TextXAlignment.Left
	modalTitle.Parent = modal

	local passBox = Instance.new("TextBox")
	passBox.Name = "PassBox"
	passBox.Size = UDim2.new(1, 0, 0, 36)
	passBox.Position = UDim2.new(0, 0, 0, 50)
	passBox.PlaceholderText = "Password"
	passBox.PlaceholderColor3 = C_Text_Dim
	passBox.BackgroundColor3 = C_Background_Lighter
	passBox.TextColor3 = C_Text
	passBox.ClearTextOnFocus = false
	passBox.Font = Enum.Font.SourceSans
	passBox.TextSize = 16
	passBox.Text = ""
	passBox.Parent = modal
	UI.PassBox = passBox
	
	local passCorner = Instance.new("UICorner")
	passCorner.CornerRadius = UDim.new(0, 6)
	passCorner.Parent = passBox
	
	local passStroke = Instance.new("UIStroke")
	passStroke.Color = C_Background_Lightest
	passStroke.Thickness = 1
	passStroke.Parent = passBox

	local getKeyButton = createButton("GetKey", "GET KEY", modal)
	getKeyButton.Size = UDim2.new(1, 0, 0, 30)
	getKeyButton.Position = UDim2.new(0, 0, 0, 96)
	getKeyButton.BackgroundColor3 = C_Background_Lighter
	getKeyButton.TextColor3 = C_Text_Dim
	UI.GetKeyButton = getKeyButton
	
	local modalStatus = Instance.new("TextLabel")
	modalStatus.Name = "Status"
	modalStatus.Size = UDim2.new(1, 0, 0, 18)
	modalStatus.Position = UDim2.new(0, 0, 0, 132)
	modalStatus.BackgroundTransparency = 1
	modalStatus.Text = ""
	modalStatus.Font = Enum.Font.SourceSans
	modalStatus.TextSize = 14
	modalStatus.TextColor3 = C_Text_Dim
	modalStatus.Parent = modal
	UI.ModalStatus = modalStatus

	local passButton = createButton("Unlock", "Unlock", modal)
	passButton.Size = UDim2.new(0.5, -4, 0, 36)
	passButton.Position = UDim2.new(0, 0, 1, -36)
	UI.PassButton = passButton

	local cancelButton = createButton("Close", "Close UI", modal)
	cancelButton.Name = "Close"
	cancelButton.Size = UDim2.new(0.5, -4, 0, 36)
	cancelButton.Position = UDim2.new(0.5, 4, 1, -36)
	cancelButton.BackgroundColor3 = C_Error
	UI.PassCancelButton = cancelButton
	
	cancelButton.MouseEnter:Connect(function() TweenService:Create(cancelButton, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(200, 70, 70)}):Play() end)
	cancelButton.MouseLeave:Connect(function() TweenService:Create(cancelButton, TweenInfo.new(0.15), {BackgroundColor3 = C_Error}):Play() end)
	
	
	local mainFrame = Instance.new("Frame")
	mainFrame.Name = "MainFrame"
	mainFrame.Size = PANEL_SIZE
	mainFrame.Position = UDim2.new(0, 60, 0, 60)
	mainFrame.BackgroundColor3 = C_Background
	mainFrame.BorderSizePixel = 0
	mainFrame.AnchorPoint = Vector2.new(0,0)
	mainFrame.Active = true
	mainFrame.ClipsDescendants = true
	mainFrame.Visible = false 
	mainFrame.ZIndex = 5
	mainFrame.Parent = screenGui
	UI.MainFrame = mainFrame

	local mainCorner = Instance.new("UICorner")
	mainCorner.CornerRadius = UDim.new(0, 8)
	mainCorner.Parent = mainFrame
	
	local mainContent = Instance.new("Frame") 
	mainContent.Name = "MainContent"
	mainContent.Size = UDim2.new(1, 0, 1, -HEADER_HEIGHT)
	mainContent.Position = UDim2.new(0, 0, 0, HEADER_HEIGHT)
	mainContent.BackgroundTransparency = 1
	mainContent.Parent = mainFrame
	UI.MainContent = mainContent
	
	local mainPadding = Instance.new("UIPadding")
	mainPadding.PaddingLeft = UDim.new(0, 12)
	mainPadding.PaddingRight = UDim.new(0, 12)
	mainPadding.PaddingTop = UDim.new(0, 12)
	mainPadding.PaddingBottom = UDim.new(0, 12)
	mainPadding.Parent = mainContent
	
	local header = Instance.new("Frame")
	header.Name = "Header"
	header.Size = UDim2.new(1, 0, 0, HEADER_HEIGHT)
	header.BackgroundColor3 = C_Background_Lighter
	header.BorderSizePixel = 0
	header.Parent = mainFrame
	UI.Header = header

	local title = Instance.new("TextLabel")
	title.Name = "Title"
	title.Size = UDim2.new(1, -100, 1, 0)
	title.Position = UDim2.new(0, 12, 0, 0)
	title.BackgroundTransparency = 1
	title.Text = "ESP Panel"
	title.TextColor3 = C_Text
	title.Font = Enum.Font.SourceSansBold
	title.TextSize = 18
	title.TextXAlignment = Enum.TextXAlignment.Left
	title.Parent = header
	
	local minimizeButton = Instance.new("TextButton")
	minimizeButton.Name = "Minimize"
	minimizeButton.Size = UDim2.new(0, 36, 1, 0)
	minimizeButton.Position = UDim2.new(1, -72, 0, 0)
	minimizeButton.BackgroundTransparency = 1
	minimizeButton.Text = "—"
	minimizeButton.Font = Enum.Font.SourceSansBold
	minimizeButton.TextSize = 20
	minimizeButton.TextColor3 = C_Text_Dim
	minimizeButton.Parent = header
	UI.MinimizeButton = minimizeButton
	
	local closeButton = Instance.new("TextButton")
	closeButton.Name = "Close"
	closeButton.Size = UDim2.new(0, 36, 1, 0)
	closeButton.Position = UDim2.new(1, -36, 0, 0)
	closeButton.BackgroundTransparency = 1
	closeButton.Text = "✕"
	closeButton.Font = Enum.Font.SourceSansBold
	closeButton.TextSize = 18
	closeButton.TextColor3 = C_Text_Dim
	closeButton.Parent = header
	UI.CloseButton = closeButton
	
	minimizeButton.MouseEnter:Connect(function() minimizeButton.TextColor3 = C_Text end)
	minimizeButton.MouseLeave:Connect(function() minimizeButton.TextColor3 = C_Text_Dim end)
	closeButton.MouseEnter:Connect(function() closeButton.TextColor3 = C_Error end)
	closeButton.MouseLeave:Connect(function() closeButton.TextColor3 = C_Text_Dim end)
	
	
	
	local inputLabel = Instance.new("TextLabel")
	inputLabel.Name = "InputLabel"
	inputLabel.Size = UDim2.new(1, 0, 0, 18)
	inputLabel.BackgroundTransparency = 1
	inputLabel.Text = "Toggle Player"
	inputLabel.Font = Enum.Font.SourceSans
	inputLabel.TextSize = 16
	inputLabel.TextColor3 = C_Text_Dim
	inputLabel.TextXAlignment = Enum.TextXAlignment.Left
	inputLabel.Parent = mainContent
	
	local inputBox = Instance.new("TextBox")
	inputBox.Name = "InputBox"
	inputBox.Size = UDim2.new(1, -82, 0, 36)
	inputBox.Position = UDim2.new(0, 0, 0, 22)
	inputBox.PlaceholderText = "Username or Display"
	inputBox.PlaceholderColor3 = C_Text_Dim
	inputBox.ClearTextOnFocus = false
	inputBox.BackgroundColor3 = C_Background_Lighter
	inputBox.TextColor3 = C_Text
	inputBox.Font = Enum.Font.SourceSans
	inputBox.TextSize = 16
	inputBox.Parent = mainContent
	UI.InputBox = inputBox
	
	local inputCorner = Instance.new("UICorner")
	inputCorner.CornerRadius = UDim.new(0, 6)
	inputCorner.Parent = inputBox
	
	local inputStroke = Instance.new("UIStroke")
	inputStroke.Color = C_Background_Lightest
	inputStroke.Thickness = 1
	inputStroke.Parent = inputBox
	
	local toggleButton = createButton("ToggleButton", "Toggle", mainContent)
	toggleButton.Size = UDim2.new(0, 70, 0, 36)
	toggleButton.Position = UDim2.new(1, -70, 0, 22)
	toggleButton.TextSize = 15
	UI.ToggleButton = toggleButton
	
	
	local viewAllLabel = Instance.new("TextLabel")
	viewAllLabel.Name = "ViewAllLabel"
	viewAllLabel.Size = UDim2.new(0.5, 0, 0, 36)
	viewAllLabel.Position = UDim2.new(0, 0, 0, 70)
	viewAllLabel.BackgroundTransparency = 1
	viewAllLabel.Text = "View Everyone"
	viewAllLabel.Font = Enum.Font.SourceSans
	viewAllLabel.TextSize = 16
	viewAllLabel.TextColor3 = C_Text_Dim
	viewAllLabel.TextXAlignment = Enum.TextXAlignment.Left
	viewAllLabel.Parent = mainContent

	local viewAllSwitch = Instance.new("TextButton")
	viewAllSwitch.Name = "ViewAllSwitch"
	viewAllSwitch.Size = UDim2.new(0, 50, 0, 26)
	viewAllSwitch.Position = UDim2.new(1, -50, 0, 75)
	viewAllSwitch.BackgroundColor3 = C_Error
	viewAllSwitch.Text = ""
	viewAllSwitch.Parent = mainContent
	UI.ViewAllSwitch = viewAllSwitch
	
	local switchCorner = Instance.new("UICorner")
	switchCorner.CornerRadius = UDim.new(0.5, 0)
	switchCorner.Parent = viewAllSwitch
	
	local switchKnob = Instance.new("Frame")
	switchKnob.Name = "Knob"
	switchKnob.Size = UDim2.new(0, 20, 0, 20)
	switchKnob.Position = UDim2.new(0, 3, 0.5, -10)
	switchKnob.BackgroundColor3 = C_Text
	switchKnob.BorderSizePixel = 0
	switchKnob.Parent = viewAllSwitch
	UI.ViewAllSwitchKnob = switchKnob
	
	local knobCorner = Instance.new("UICorner")
	knobCorner.CornerRadius = UDim.new(0.5, 0)
	knobCorner.Parent = switchKnob
	
	
	local activeLabel = Instance.new("TextLabel")
	activeLabel.Name = "ActiveLabel"
	activeLabel.Size = UDim2.new(1, 0, 0, 18)
	activeLabel.Position = UDim2.new(0, 0, 0, 120)
	activeLabel.BackgroundTransparency = 1
	activeLabel.Text = "Active Players (0)"
	activeLabel.Font = Enum.Font.SourceSans
	activeLabel.TextSize = 16
	activeLabel.TextColor3 = C_Text_Dim
	activeLabel.TextXAlignment = Enum.TextXAlignment.Left
	activeLabel.Parent = mainContent
	UI.ActiveLabel = activeLabel
	
	local activeListFrame = Instance.new("ScrollingFrame")
	activeListFrame.Name = "ActiveListFrame"
	activeListFrame.Size = UDim2.new(1, 0, 1, -142)
	activeListFrame.Position = UDim2.new(0, 0, 0, 142)
	activeListFrame.BackgroundColor3 = C_Background_Lighter
	activeListFrame.BorderSizePixel = 0
	activeListFrame.ScrollBarThickness = 6
	activeListFrame.ScrollBarImageColor3 = C_Primary
	activeListFrame.Parent = mainContent
	UI.ActiveListFrame = activeListFrame
	
	local listCorner = Instance.new("UICorner")
	listCorner.CornerRadius = UDim.new(0, 6)
	listCorner.Parent = activeListFrame
	
	local listLayout = Instance.new("UIListLayout")
	listLayout.Padding = UDim.new(0, 4)
	listLayout.SortOrder = Enum.SortOrder.Name
	listLayout.Parent = activeListFrame
	
	local listPadding = Instance.new("UIPadding")
	listPadding.PaddingLeft = UDim.new(0, 4)
	listPadding.PaddingRight = UDim.new(0, 4)
	listPadding.PaddingTop = UDim.new(0, 4)
	listPadding.PaddingBottom = UDim.new(0, 4)
	listPadding.Parent = activeListFrame
	
	
	screenGui.Parent = PlayerGui
	return screenGui
end


local function createESP(player)
	if not player or player == LocalPlayer and EXCLUDE_LOCALPLAYER or ESPs[player] then return end
	local char = player.Character
	if not char then return end
	local root = char:FindFirstChild("HumanoidRootPart")
	local hum = char:FindFirstChildOfClass("Humanoid")
	if not root or not hum then return end
	
	
	if ESPs[player] then return end

	local billboard = Instance.new("BillboardGui")
	billboard.Name = "ESP_Billboard"
	billboard.Adornee = root
	billboard.Size = UDim2.new(0, 150, 0, 50)
	billboard.StudsOffset = Vector3.new(0, 3, 0)
	billboard.AlwaysOnTop = true
	billboard.Parent = root
	
	
	local espFrame = Instance.new("Frame")
	espFrame.Name = "ESPFrame"
	espFrame.Size = UDim2.new(1, 0, 1, 0)
	espFrame.BackgroundTransparency = 1
	espFrame.Parent = billboard

	
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Name = "Name"
	nameLabel.Size = UDim2.new(1, 0, 0, 20)
	nameLabel.Position = UDim2.new(0, 0, 0, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.TextScaled = false
	nameLabel.TextSize = 18
	nameLabel.TextColor3 = C_Error
	nameLabel.TextStrokeTransparency = 0.5
	nameLabel.Text = player.DisplayName
	nameLabel.Parent = espFrame
	
	
	local distLabel = Instance.new("TextLabel")
	distLabel.Name = "Dist"
	distLabel.Size = UDim2.new(1, 0, 0, 16)
	distLabel.Position = UDim2.new(0, 0, 0, 18)
	distLabel.BackgroundTransparency = 1
	distLabel.Font = Enum.Font.SourceSans
	distLabel.TextScaled = false
	distLabel.TextSize = 14
	distLabel.TextColor3 = C_Text
	distLabel.TextStrokeTransparency = 0.6
	distLabel.Text = ""
	distLabel.Parent = espFrame
	
	
	local healthBar = Instance.new("Frame")
	healthBar.Name = "HealthBar"
	healthBar.Size = UDim2.new(1, 0, 0, 8)
	healthBar.Position = UDim2.new(0, 0, 1, -8)
	healthBar.BackgroundColor3 = C_Text_Dark
	healthBar.BorderSizePixel = 0
	healthBar.Parent = espFrame
	
	local healthCorner = Instance.new("UICorner")
	healthCorner.CornerRadius = UDim.new(0, 3)
	healthCorner.Parent = healthBar
	
	local healthFill = Instance.new("Frame")
	healthFill.Name = "Fill"
	healthFill.Size = UDim2.new(hum.Health / hum.MaxHealth, 0, 1, 0)
	healthFill.BackgroundColor3 = C_Success
	healthFill.BorderSizePixel = 0
	healthFill.Parent = healthBar
	
	local healthFillCorner = Instance.new("UICorner")
	healthFillCorner.CornerRadius = UDim.new(0, 3)
	healthFillCorner.Parent = healthFill
	
	
	local box = Instance.new("Frame")
	box.Name = "Box"
	box.Size = UDim2.new(1, 0, 1, -12) 
	box.Position = UDim2.new(0, 0, 0, 0)
	box.BackgroundTransparency = 1
	box.ZIndex = -1
	box.Parent = espFrame
	
	local boxStroke = Instance.new("UIStroke")
	boxStroke.Color = C_Error
	boxStroke.Thickness = 2
	boxStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	boxStroke.Parent = box

	
	local connections = {}
	
	
	table.insert(connections, hum.HealthChanged:Connect(function(health)
		local perc = math.clamp(health / hum.MaxHealth, 0, 1)
		TweenService:Create(healthFill, TweenInfo.new(0.2), {Size = UDim2.new(perc, 0, 1, 0)}):Play()
		if perc < 0.3 then
			healthFill.BackgroundColor3 = C_Error
		elseif perc < 0.6 then
			healthFill.BackgroundColor3 = Color3.fromRGB(255, 165, 0) 
		else
			healthFill.BackgroundColor3 = C_Success
		end
	end))

	ESPs[player] = {
		billboard = billboard,
		nameLabel = nameLabel,
		distLabel = distLabel,
		healthFill = healthFill,
		boxStroke = boxStroke,
		connections = connections
	}
end

local function removeESP(player)
	local data = ESPs[player]
	if data then
		
		for _, conn in ipairs(data.connections) do
			conn:Disconnect()
		end
		if data.billboard then
			data.billboard:Destroy()
		end
	end
	ESPs[player] = nil
end


local function updateESP(player, data, myRootPos)
	if not player or not player.Character then
		removeESP(player)
		return
	end
	local root = player.Character:FindFirstChild("HumanoidRootPart")
	if not root then
		removeESP(player)
		return
	end
	
	
	local dist = (myRootPos - root.Position).Magnitude
	if ShowDistance and data.distLabel then
		data.distLabel.Text = string.format("%.0f studs", dist)
	end
	
	
	local color = (player.Team == LocalPlayer.Team) and C_Success or C_Error
	if data.nameLabel.TextColor3 ~= color then
		data.nameLabel.TextColor3 = color
	end
	if data.boxStroke.Color ~= color then
		data.boxStroke.Color = color
	end
end


local function updateActiveList()
	UI.ActiveListFrame:ClearAllChildren()
	local count = 0
	
	
	local listLayout = Instance.new("UIListLayout")
	listLayout.Padding = UDim.new(0, 4)
	listLayout.SortOrder = Enum.SortOrder.Name
	listLayout.Parent = UI.ActiveListFrame
	
	for p, enabled in pairs(ESPEnabled) do
		if enabled and p then
			count = count + 1
			local playerTag = Instance.new("Frame")
			playerTag.Name = p.Name
			playerTag.Size = UDim2.new(1, 0, 0, 28)
			playerTag.BackgroundColor3 = C_Background
			playerTag.Parent = UI.ActiveListFrame
			
			local tagCorner = Instance.new("UICorner")
			tagCorner.CornerRadius = UDim.new(0, 4)
			tagCorner.Parent = playerTag
			
			local tagName = Instance.new("TextLabel")
			tagName.Size = UDim2.new(1, -30, 1, 0)
			tagName.Position = UDim2.new(0, 8, 0, 0)
			tagName.BackgroundTransparency = 1
			tagName.Text = p.DisplayName .. " (@" .. p.Name .. ")"
			tagName.Font = Enum.Font.SourceSans
			tagName.TextSize = 15
			tagName.TextColor3 = (p.Team == LocalPlayer.Team) and C_Success or C_Error
			tagName.TextXAlignment = Enum.TextXAlignment.Left
			tagName.Parent = playerTag
			
			
			local tagRemove = Instance.new("TextButton")
			tagRemove.Size = UDim2.new(0, 28, 1, 0)
			tagRemove.Position = UDim2.new(1, -28, 0, 0)
			tagRemove.BackgroundTransparency = 1
			tagRemove.Text = "✕"
			tagRemove.Font = Enum.Font.SourceSansBold
			tagRemove.TextSize = 16
			tagRemove.TextColor3 = C_Text_Dim
			tagRemove.Parent = playerTag
			
			tagRemove.MouseEnter:Connect(function() tagRemove.TextColor3 = C_Error end)
			tagRemove.MouseLeave:Connect(function() tagRemove.TextColor3 = C_Text_Dim end)
			
			tagRemove.MouseButton1Click:Connect(function()
				ESPEnabled[p] = false
				removeESP(p)
				updateActiveList()
			end)
		end
	end
	
	UI.ActiveLabel.Text = string.format("Active Players (%d)", count)
end

local function findPlayerByNameOrDisplay(text)
	local t = norm(text)
	if t == "" then return nil end
	for _, p in pairs(Players:GetPlayers()) do
		if norm(p.Name) == t or norm(p.DisplayName) == t then
			return p
		end
	end
	return nil
end


local function onTogglePlayer()
	local txt = UI.InputBox.Text
	local target = findPlayerByNameOrDisplay(txt)
	
	if not target then
		warn("Player not found: "..tostring(txt))
		
		local oldColor = UI.InputBox.BackgroundColor3
		UI.InputBox.BackgroundColor3 = C_Error
		task.wait(0.3)
		UI.InputBox.BackgroundColor3 = oldColor
		return
	end
	
	if ESPEnabled[target] then
		ESPEnabled[target] = false
		removeESP(target)
	else
		ESPEnabled[target] = true
		if target.Character then createESP(target) end
	end
	
	UI.InputBox.Text = ""
	updateActiveList()
end


local function setViewAll(on)
	viewAllEnabled = on
	
	
	local targetColor = on and C_Success or C_Error
	local targetPos = on and UDim2.new(1, -23, 0.5, -10) or UDim2.new(0, 3, 0.5, -10)
	
	TweenService:Create(UI.ViewAllSwitch, TweenInfo.new(0.2), {BackgroundColor3 = targetColor}):Play()
	TweenService:Create(UI.ViewAllSwitchKnob, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {Position = targetPos}):Play()
	
	
	if on then
		for _, p in pairs(Players:GetPlayers()) do
			if not (p == LocalPlayer and EXCLUDE_LOCALPLAYER) then
				ESPEnabled[p] = true
				if p.Character then createESP(p) end
			end
		end
	else
		
		
		for p, _ in pairs(ESPEnabled) do
			ESPEnabled[p] = false
			removeESP(p)
		end
	end
	
	updateActiveList()
end


local function unlockUI()
	TweenService:Create(UI.PasswordOverlay, TweenInfo.new(0.3), {BackgroundTransparency = 1}):Play()
	UI.PasswordOverlay:Destroy() 
	UI.MainFrame.Visible = true
end


local function initPasswordModal()
	UI.PassButton.MouseButton1Click:Connect(function()
		if UI.PassBox.Text == FUNCTION then
			unlockUI()
		else
			UI.PassBox.Text = ""
			
			local startPos = UI.PasswordOverlay.Modal.Position
			local tweenInfo = TweenInfo.new(0.06, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, 3, true)
			local tween = TweenService:Create(UI.PasswordOverlay.Modal, tweenInfo, {Position = startPos + UDim2.new(0,6,0,0)})
			tween:Play()
		end
	end)

	UI.PassCancelButton.MouseButton1Click:Connect(function()
		UI.PasswordOverlay.Parent:Destroy() 
	end)

	UI.PassBox.FocusLost:Connect(function(enterPressed)
		if enterPressed then
			UI.PassButton.MouseButton1Click:Invoke()
		end
	end)
	
	UI.GetKeyButton.MouseButton1Click:Connect(function()
		local success = tryCopyToClipboard("https://raw.githubusercontent.com/MegeTech/megeHub-ESP/refs/heads/main/--%20LocalScript%20(1).txt")
		local oldText = UI.GetKeyButton.Text
		if success then
			UI.ModalStatus.Text = "Copied link to clipboard!"
			UI.GetKeyButton.Text = "Copied!"
		else
			UI.ModalStatus.Text = "Failed to copy. Please copy manually: https://raw.githubusercontent.com/MegeTech/megeHub-ESP/refs/heads/main/--%20LocalScript%20(1).txt"
			UI.GetKeyButton.Text = "Failed!"
		end
		
		task.delay(2, function()
			if UI.ModalStatus and UI.ModalStatus.Parent then UI.ModalStatus.Text = "" end
			if UI.GetKeyButton and UI.GetKeyButton.Parent then UI.GetKeyButton.Text = oldText end
		end)
	end)
end


local function initMainPanel()
	
	local dragging, dragStart
	UI.Header.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			local startPos = UI.MainFrame.Position
			
			local moveConn
			moveConn = UserInputService.InputChanged:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
					if dragging then
						local delta = input.Position - dragStart
						UI.MainFrame.Position = UDim2.new(0, startPos.X.Offset + delta.X, 0, startPos.Y.Offset + delta.Y)
					end
				end
			end)
			
			local endConn
			endConn = UserInputService.InputEnded:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
					dragging = false
					if moveConn then moveConn:Disconnect() end
					if endConn then endConn:Disconnect() end
				end
			end)
		end
	end)

	
	local minimized = false
	UI.MinimizeButton.MouseButton1Click:Connect(function()
		minimized = not minimized
		UI.MainContent.Visible = not minimized
		local targetSize = minimized and UDim2.new(PANEL_SIZE.X.Scale, PANEL_SIZE.X.Offset, 0, HEADER_HEIGHT) or PANEL_SIZE
		TweenService:Create(UI.MainFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {Size = targetSize}):Play()
	end)

	
	UI.CloseButton.MouseButton1Click:Connect(function()
		UI.MainFrame.Parent:Destroy()
	end)
	
	
	UI.ToggleButton.MouseButton1Click:Connect(onTogglePlayer)
	UI.InputBox.FocusLost:Connect(function(enterPressed)
		if enterPressed then
			onTogglePlayer()
		end
	end)
	
	UI.ViewAllSwitch.MouseButton1Click:Connect(function()
		setViewAll(not viewAllEnabled)
	end)
end


createGUI()

initPasswordModal()
initMainPanel()


Players.PlayerAdded:Connect(function(p)
	if viewAllEnabled then
		ESPEnabled[p] = true
		
		p.CharacterAdded:Connect(function(char)
			task.wait(0.1) 
			if ESPEnabled[p] then createESP(p) end
		end)
		updateActiveList()
	end
	
	
	p.CharacterAdded:Connect(function(char)
		task.wait(0.1)
		if ESPEnabled[p] then
			removeESP(p) 
			createESP(p)
		end
	end)
end)

Players.PlayerRemoving:Connect(function(p)
	ESPEnabled[p] = nil
	removeESP(p)
	updateActiveList()
end)


for _, p in pairs(Players:GetPlayers()) do
	p.CharacterAdded:Connect(function(char)
		task.wait(0.1)
		if ESPEnabled[p] then
			removeESP(p) 
			createESP(p)
		end
	end)
end


RunService.RenderStepped:Connect(function()
	if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
		
		for p, _ in pairs(ESPs) do removeESP(p) end
		return
	end
	
	local myRoot = LocalPlayer.Character.HumanoidRootPart
	
	for player, data in pairs(ESPs) do
		updateESP(player, data, myRoot.Position)
	end
end)	local ok, err = pcall(function() setclipboard(text) end)
	return ok
end


local function createButton(name, text, parent)
	local btn = Instance.new("TextButton")
	btn.Name = name
	btn.Text = text
	btn.Parent = parent
	btn.BackgroundColor3 = C_Primary
	btn.TextColor3 = C_Text
	btn.Font = Enum.Font.SourceSansBold
	btn.TextSize = 16
	btn.BorderSizePixel = 0
	
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 6)
	corner.Parent = btn
	
	
	btn.MouseEnter:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = C_Primary_Dark}):Play()
	end)
	btn.MouseLeave:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = C_Primary}):Play()
	end)
	
	return btn
end


local function createGUI()
	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "ModernESPUI_v2"
	screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	screenGui.ResetOnSpawn = false
	
	
	local overlay = Instance.new("Frame")
	overlay.Name = "PasswordOverlay"
	overlay.Size = UDim2.new(1,0,1,0)
	overlay.Position = UDim2.new(0,0,0,0)
	overlay.BackgroundColor3 = Color3.fromRGB(0,0,0)
	overlay.BackgroundTransparency = 0.5
	overlay.ZIndex = 10
	overlay.Parent = screenGui
	UI.PasswordOverlay = overlay

	local modal = Instance.new("Frame")
	modal.Name = "Modal"
	modal.Size = UDim2.new(0, 360, 0, 220)
	modal.Position = UDim2.new(0.5, -180, 0.5, -110)
	modal.BackgroundColor3 = C_Background
	modal.BorderSizePixel = 0
	modal.Parent = overlay
	
	local modalCorner = Instance.new("UICorner")
	modalCorner.CornerRadius = UDim.new(0, 8)
	modalCorner.Parent = modal
	
	local modalPadding = Instance.new("UIPadding")
	modalPadding.PaddingLeft = UDim.new(0, 16)
	modalPadding.PaddingRight = UDim.new(0, 16)
	modalPadding.PaddingTop = UDim.new(0, 16)
	modalPadding.PaddingBottom = UDim.new(0, 16)
	modalPadding.Parent = modal

	local modalTitle = Instance.new("TextLabel")
	modalTitle.Name = "Title"
	modalTitle.Size = UDim2.new(1, 0, 0, 30)
	modalTitle.BackgroundTransparency = 1
	modalTitle.Text = "Panel Authentication"
	modalTitle.Font = Enum.Font.SourceSansBold
	modalTitle.TextSize = 20
	modalTitle.TextColor3 = C_Text
	modalTitle.TextXAlignment = Enum.TextXAlignment.Left
	modalTitle.Parent = modal

	local passBox = Instance.new("TextBox")
	passBox.Name = "PassBox"
	passBox.Size = UDim2.new(1, 0, 0, 36)
	passBox.Position = UDim2.new(0, 0, 0, 50)
	passBox.PlaceholderText = "Password"
	passBox.PlaceholderColor3 = C_Text_Dim
	passBox.BackgroundColor3 = C_Background_Lighter
	passBox.TextColor3 = C_Text
	passBox.ClearTextOnFocus = false
	passBox.Font = Enum.Font.SourceSans
	passBox.TextSize = 16
	passBox.Text = ""
	passBox.Parent = modal
	UI.PassBox = passBox
	
	local passCorner = Instance.new("UICorner")
	passCorner.CornerRadius = UDim.new(0, 6)
	passCorner.Parent = passBox
	
	local passStroke = Instance.new("UIStroke")
	passStroke.Color = C_Background_Lightest
	passStroke.Thickness = 1
	passStroke.Parent = passBox

	local getKeyButton = createButton("GetKey", "GET KEY", modal)
	getKeyButton.Size = UDim2.new(1, 0, 0, 30)
	getKeyButton.Position = UDim2.new(0, 0, 0, 96)
	getKeyButton.BackgroundColor3 = C_Background_Lighter
	getKeyButton.TextColor3 = C_Text_Dim
	UI.GetKeyButton = getKeyButton
	
	local modalStatus = Instance.new("TextLabel")
	modalStatus.Name = "Status"
	modalStatus.Size = UDim2.new(1, 0, 0, 18)
	modalStatus.Position = UDim2.new(0, 0, 0, 132)
	modalStatus.BackgroundTransparency = 1
	modalStatus.Text = ""
	modalStatus.Font = Enum.Font.SourceSans
	modalStatus.TextSize = 14
	modalStatus.TextColor3 = C_Text_Dim
	modalStatus.Parent = modal
	UI.ModalStatus = modalStatus

	local passButton = createButton("Unlock", "Unlock", modal)
	passButton.Size = UDim2.new(0.5, -4, 0, 36)
	passButton.Position = UDim2.new(0, 0, 1, -36)
	UI.PassButton = passButton

	local cancelButton = createButton("Close", "Close UI", modal)
	cancelButton.Name = "Close"
	cancelButton.Size = UDim2.new(0.5, -4, 0, 36)
	cancelButton.Position = UDim2.new(0.5, 4, 1, -36)
	cancelButton.BackgroundColor3 = C_Error
	UI.PassCancelButton = cancelButton
	
	cancelButton.MouseEnter:Connect(function() TweenService:Create(cancelButton, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(200, 70, 70)}):Play() end)
	cancelButton.MouseLeave:Connect(function() TweenService:Create(cancelButton, TweenInfo.new(0.15), {BackgroundColor3 = C_Error}):Play() end)
	
	
	local mainFrame = Instance.new("Frame")
	mainFrame.Name = "MainFrame"
	mainFrame.Size = PANEL_SIZE
	mainFrame.Position = UDim2.new(0, 60, 0, 60)
	mainFrame.BackgroundColor3 = C_Background
	mainFrame.BorderSizePixel = 0
	mainFrame.AnchorPoint = Vector2.new(0,0)
	mainFrame.Active = true
	mainFrame.ClipsDescendants = true
	mainFrame.Visible = false 
	mainFrame.ZIndex = 5
	mainFrame.Parent = screenGui
	UI.MainFrame = mainFrame

	local mainCorner = Instance.new("UICorner")
	mainCorner.CornerRadius = UDim.new(0, 8)
	mainCorner.Parent = mainFrame
	
	local mainContent = Instance.new("Frame") 
	mainContent.Name = "MainContent"
	mainContent.Size = UDim2.new(1, 0, 1, -HEADER_HEIGHT)
	mainContent.Position = UDim2.new(0, 0, 0, HEADER_HEIGHT)
	mainContent.BackgroundTransparency = 1
	mainContent.Parent = mainFrame
	UI.MainContent = mainContent
	
	local mainPadding = Instance.new("UIPadding")
	mainPadding.PaddingLeft = UDim.new(0, 12)
	mainPadding.PaddingRight = UDim.new(0, 12)
	mainPadding.PaddingTop = UDim.new(0, 12)
	mainPadding.PaddingBottom = UDim.new(0, 12)
	mainPadding.Parent = mainContent
	
	local header = Instance.new("Frame")
	header.Name = "Header"
	header.Size = UDim2.new(1, 0, 0, HEADER_HEIGHT)
	header.BackgroundColor3 = C_Background_Lighter
	header.BorderSizePixel = 0
	header.Parent = mainFrame
	UI.Header = header

	local title = Instance.new("TextLabel")
	title.Name = "Title"
	title.Size = UDim2.new(1, -100, 1, 0)
	title.Position = UDim2.new(0, 12, 0, 0)
	title.BackgroundTransparency = 1
	title.Text = "ESP Panel"
	title.TextColor3 = C_Text
	title.Font = Enum.Font.SourceSansBold
	title.TextSize = 18
	title.TextXAlignment = Enum.TextXAlignment.Left
	title.Parent = header
	
	local minimizeButton = Instance.new("TextButton")
	minimizeButton.Name = "Minimize"
	minimizeButton.Size = UDim2.new(0, 36, 1, 0)
	minimizeButton.Position = UDim2.new(1, -72, 0, 0)
	minimizeButton.BackgroundTransparency = 1
	minimizeButton.Text = "—"
	minimizeButton.Font = Enum.Font.SourceSansBold
	minimizeButton.TextSize = 20
	minimizeButton.TextColor3 = C_Text_Dim
	minimizeButton.Parent = header
	UI.MinimizeButton = minimizeButton
	
	local closeButton = Instance.new("TextButton")
	closeButton.Name = "Close"
	closeButton.Size = UDim2.new(0, 36, 1, 0)
	closeButton.Position = UDim2.new(1, -36, 0, 0)
	closeButton.BackgroundTransparency = 1
	closeButton.Text = "✕"
	closeButton.Font = Enum.Font.SourceSansBold
	closeButton.TextSize = 18
	closeButton.TextColor3 = C_Text_Dim
	closeButton.Parent = header
	UI.CloseButton = closeButton
	
	minimizeButton.MouseEnter:Connect(function() minimizeButton.TextColor3 = C_Text end)
	minimizeButton.MouseLeave:Connect(function() minimizeButton.TextColor3 = C_Text_Dim end)
	closeButton.MouseEnter:Connect(function() closeButton.TextColor3 = C_Error end)
	closeButton.MouseLeave:Connect(function() closeButton.TextColor3 = C_Text_Dim end)
	
	
	
	local inputLabel = Instance.new("TextLabel")
	inputLabel.Name = "InputLabel"
	inputLabel.Size = UDim2.new(1, 0, 0, 18)
	inputLabel.BackgroundTransparency = 1
	inputLabel.Text = "Toggle Player"
	inputLabel.Font = Enum.Font.SourceSans
	inputLabel.TextSize = 16
	inputLabel.TextColor3 = C_Text_Dim
	inputLabel.TextXAlignment = Enum.TextXAlignment.Left
	inputLabel.Parent = mainContent
	
	local inputBox = Instance.new("TextBox")
	inputBox.Name = "InputBox"
	inputBox.Size = UDim2.new(1, -82, 0, 36)
	inputBox.Position = UDim2.new(0, 0, 0, 22)
	inputBox.PlaceholderText = "Username or Display"
	inputBox.PlaceholderColor3 = C_Text_Dim
	inputBox.ClearTextOnFocus = false
	inputBox.BackgroundColor3 = C_Background_Lighter
	inputBox.TextColor3 = C_Text
	inputBox.Font = Enum.Font.SourceSans
	inputBox.TextSize = 16
	inputBox.Parent = mainContent
	UI.InputBox = inputBox
	
	local inputCorner = Instance.new("UICorner")
	inputCorner.CornerRadius = UDim.new(0, 6)
	inputCorner.Parent = inputBox
	
	local inputStroke = Instance.new("UIStroke")
	inputStroke.Color = C_Background_Lightest
	inputStroke.Thickness = 1
	inputStroke.Parent = inputBox
	
	local toggleButton = createButton("ToggleButton", "Toggle", mainContent)
	toggleButton.Size = UDim2.new(0, 70, 0, 36)
	toggleButton.Position = UDim2.new(1, -70, 0, 22)
	toggleButton.TextSize = 15
	UI.ToggleButton = toggleButton
	
	
	local viewAllLabel = Instance.new("TextLabel")
	viewAllLabel.Name = "ViewAllLabel"
	viewAllLabel.Size = UDim2.new(0.5, 0, 0, 36)
	viewAllLabel.Position = UDim2.new(0, 0, 0, 70)
	viewAllLabel.BackgroundTransparency = 1
	viewAllLabel.Text = "View Everyone"
	viewAllLabel.Font = Enum.Font.SourceSans
	viewAllLabel.TextSize = 16
	viewAllLabel.TextColor3 = C_Text_Dim
	viewAllLabel.TextXAlignment = Enum.TextXAlignment.Left
	viewAllLabel.Parent = mainContent

	local viewAllSwitch = Instance.new("TextButton")
	viewAllSwitch.Name = "ViewAllSwitch"
	viewAllSwitch.Size = UDim2.new(0, 50, 0, 26)
	viewAllSwitch.Position = UDim2.new(1, -50, 0, 75)
	viewAllSwitch.BackgroundColor3 = C_Error
	viewAllSwitch.Text = ""
	viewAllSwitch.Parent = mainContent
	UI.ViewAllSwitch = viewAllSwitch
	
	local switchCorner = Instance.new("UICorner")
	switchCorner.CornerRadius = UDim.new(0.5, 0)
	switchCorner.Parent = viewAllSwitch
	
	local switchKnob = Instance.new("Frame")
	switchKnob.Name = "Knob"
	switchKnob.Size = UDim2.new(0, 20, 0, 20)
	switchKnob.Position = UDim2.new(0, 3, 0.5, -10)
	switchKnob.BackgroundColor3 = C_Text
	switchKnob.BorderSizePixel = 0
	switchKnob.Parent = viewAllSwitch
	UI.ViewAllSwitchKnob = switchKnob
	
	local knobCorner = Instance.new("UICorner")
	knobCorner.CornerRadius = UDim.new(0.5, 0)
	knobCorner.Parent = switchKnob
	
	
	local activeLabel = Instance.new("TextLabel")
	activeLabel.Name = "ActiveLabel"
	activeLabel.Size = UDim2.new(1, 0, 0, 18)
	activeLabel.Position = UDim2.new(0, 0, 0, 120)
	activeLabel.BackgroundTransparency = 1
	activeLabel.Text = "Active Players (0)"
	activeLabel.Font = Enum.Font.SourceSans
	activeLabel.TextSize = 16
	activeLabel.TextColor3 = C_Text_Dim
	activeLabel.TextXAlignment = Enum.TextXAlignment.Left
	activeLabel.Parent = mainContent
	UI.ActiveLabel = activeLabel
	
	local activeListFrame = Instance.new("ScrollingFrame")
	activeListFrame.Name = "ActiveListFrame"
	activeListFrame.Size = UDim2.new(1, 0, 1, -142)
	activeListFrame.Position = UDim2.new(0, 0, 0, 142)
	activeListFrame.BackgroundColor3 = C_Background_Lighter
	activeListFrame.BorderSizePixel = 0
	activeListFrame.ScrollBarThickness = 6
	activeListFrame.ScrollBarImageColor3 = C_Primary
	activeListFrame.Parent = mainContent
	UI.ActiveListFrame = activeListFrame
	
	local listCorner = Instance.new("UICorner")
	listCorner.CornerRadius = UDim.new(0, 6)
	listCorner.Parent = activeListFrame
	
	local listLayout = Instance.new("UIListLayout")
	listLayout.Padding = UDim.new(0, 4)
	listLayout.SortOrder = Enum.SortOrder.Name
	listLayout.Parent = activeListFrame
	
	local listPadding = Instance.new("UIPadding")
	listPadding.PaddingLeft = UDim.new(0, 4)
	listPadding.PaddingRight = UDim.new(0, 4)
	listPadding.PaddingTop = UDim.new(0, 4)
	listPadding.PaddingBottom = UDim.new(0, 4)
	listPadding.Parent = activeListFrame
	
	
	screenGui.Parent = PlayerGui
	return screenGui
end


local function createESP(player)
	if not player or player == LocalPlayer and EXCLUDE_LOCALPLAYER or ESPs[player] then return end
	local char = player.Character
	if not char then return end
	local root = char:FindFirstChild("HumanoidRootPart")
	local hum = char:FindFirstChildOfClass("Humanoid")
	if not root or not hum then return end
	
	
	if ESPs[player] then return end

	local billboard = Instance.new("BillboardGui")
	billboard.Name = "ESP_Billboard"
	billboard.Adornee = root
	billboard.Size = UDim2.new(0, 150, 0, 50)
	billboard.StudsOffset = Vector3.new(0, 3, 0)
	billboard.AlwaysOnTop = true
	billboard.Parent = root
	
	
	local espFrame = Instance.new("Frame")
	espFrame.Name = "ESPFrame"
	espFrame.Size = UDim2.new(1, 0, 1, 0)
	espFrame.BackgroundTransparency = 1
	espFrame.Parent = billboard

	
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Name = "Name"
	nameLabel.Size = UDim2.new(1, 0, 0, 20)
	nameLabel.Position = UDim2.new(0, 0, 0, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.TextScaled = false
	nameLabel.TextSize = 18
	nameLabel.TextColor3 = C_Error
	nameLabel.TextStrokeTransparency = 0.5
	nameLabel.Text = player.DisplayName
	nameLabel.Parent = espFrame
	
	
	local distLabel = Instance.new("TextLabel")
	distLabel.Name = "Dist"
	distLabel.Size = UDim2.new(1, 0, 0, 16)
	distLabel.Position = UDim2.new(0, 0, 0, 18)
	distLabel.BackgroundTransparency = 1
	distLabel.Font = Enum.Font.SourceSans
	distLabel.TextScaled = false
	distLabel.TextSize = 14
	distLabel.TextColor3 = C_Text
	distLabel.TextStrokeTransparency = 0.6
	distLabel.Text = ""
	distLabel.Parent = espFrame
	
	
	local healthBar = Instance.new("Frame")
	healthBar.Name = "HealthBar"
	healthBar.Size = UDim2.new(1, 0, 0, 8)
	healthBar.Position = UDim2.new(0, 0, 1, -8)
	healthBar.BackgroundColor3 = C_Text_Dark
	healthBar.BorderSizePixel = 0
	healthBar.Parent = espFrame
	
	local healthCorner = Instance.new("UICorner")
	healthCorner.CornerRadius = UDim.new(0, 3)
	healthCorner.Parent = healthBar
	
	local healthFill = Instance.new("Frame")
	healthFill.Name = "Fill"
	healthFill.Size = UDim2.new(hum.Health / hum.MaxHealth, 0, 1, 0)
	healthFill.BackgroundColor3 = C_Success
	healthFill.BorderSizePixel = 0
	healthFill.Parent = healthBar
	
	local healthFillCorner = Instance.new("UICorner")
	healthFillCorner.CornerRadius = UDim.new(0, 3)
	healthFillCorner.Parent = healthFill
	
	
	local box = Instance.new("Frame")
	box.Name = "Box"
	box.Size = UDim2.new(1, 0, 1, -12) 
	box.Position = UDim2.new(0, 0, 0, 0)
	box.BackgroundTransparency = 1
	box.ZIndex = -1
	box.Parent = espFrame
	
	local boxStroke = Instance.new("UIStroke")
	boxStroke.Color = C_Error
	boxStroke.Thickness = 2
	boxStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	boxStroke.Parent = box

	
	local connections = {}
	
	
	table.insert(connections, hum.HealthChanged:Connect(function(health)
		local perc = math.clamp(health / hum.MaxHealth, 0, 1)
		TweenService:Create(healthFill, TweenInfo.new(0.2), {Size = UDim2.new(perc, 0, 1, 0)}):Play()
		if perc < 0.3 then
			healthFill.BackgroundColor3 = C_Error
		elseif perc < 0.6 then
			healthFill.BackgroundColor3 = Color3.fromRGB(255, 165, 0) 
		else
			healthFill.BackgroundColor3 = C_Success
		end
	end))

	ESPs[player] = {
		billboard = billboard,
		nameLabel = nameLabel,
		distLabel = distLabel,
		healthFill = healthFill,
		boxStroke = boxStroke,
		connections = connections
	}
end

local function removeESP(player)
	local data = ESPs[player]
	if data then
		
		for _, conn in ipairs(data.connections) do
			conn:Disconnect()
		end
		if data.billboard then
			data.billboard:Destroy()
		end
	end
	ESPs[player] = nil
end


local function updateESP(player, data, myRootPos)
	if not player or not player.Character then
		removeESP(player)
		return
	end
	local root = player.Character:FindFirstChild("HumanoidRootPart")
	if not root then
		removeESP(player)
		return
	end
	
	
	local dist = (myRootPos - root.Position).Magnitude
	if ShowDistance and data.distLabel then
		data.distLabel.Text = string.format("%.0f studs", dist)
	end
	
	
	local color = (player.Team == LocalPlayer.Team) and C_Success or C_Error
	if data.nameLabel.TextColor3 ~= color then
		data.nameLabel.TextColor3 = color
	end
	if data.boxStroke.Color ~= color then
		data.boxStroke.Color = color
	end
end


local function updateActiveList()
	UI.ActiveListFrame:ClearAllChildren()
	local count = 0
	
	
	local listLayout = Instance.new("UIListLayout")
	listLayout.Padding = UDim.new(0, 4)
	listLayout.SortOrder = Enum.SortOrder.Name
	listLayout.Parent = UI.ActiveListFrame
	
	for p, enabled in pairs(ESPEnabled) do
		if enabled and p then
			count = count + 1
			local playerTag = Instance.new("Frame")
			playerTag.Name = p.Name
			playerTag.Size = UDim2.new(1, 0, 0, 28)
			playerTag.BackgroundColor3 = C_Background
			playerTag.Parent = UI.ActiveListFrame
			
			local tagCorner = Instance.new("UICorner")
			tagCorner.CornerRadius = UDim.new(0, 4)
			tagCorner.Parent = playerTag
			
			local tagName = Instance.new("TextLabel")
			tagName.Size = UDim2.new(1, -30, 1, 0)
			tagName.Position = UDim2.new(0, 8, 0, 0)
			tagName.BackgroundTransparency = 1
			tagName.Text = p.DisplayName .. " (@" .. p.Name .. ")"
			tagName.Font = Enum.Font.SourceSans
			tagName.TextSize = 15
			tagName.TextColor3 = (p.Team == LocalPlayer.Team) and C_Success or C_Error
			tagName.TextXAlignment = Enum.TextXAlignment.Left
			tagName.Parent = playerTag
			
			
			local tagRemove = Instance.new("TextButton")
			tagRemove.Size = UDim2.new(0, 28, 1, 0)
			tagRemove.Position = UDim2.new(1, -28, 0, 0)
			tagRemove.BackgroundTransparency = 1
			tagRemove.Text = "✕"
			tagRemove.Font = Enum.Font.SourceSansBold
			tagRemove.TextSize = 16
			tagRemove.TextColor3 = C_Text_Dim
			tagRemove.Parent = playerTag
			
			tagRemove.MouseEnter:Connect(function() tagRemove.TextColor3 = C_Error end)
			tagRemove.MouseLeave:Connect(function() tagRemove.TextColor3 = C_Text_Dim end)
			
			tagRemove.MouseButton1Click:Connect(function()
				ESPEnabled[p] = false
				removeESP(p)
				updateActiveList()
			end)
		end
	end
	
	UI.ActiveLabel.Text = string.format("Active Players (%d)", count)
end

local function findPlayerByNameOrDisplay(text)
	local t = norm(text)
	if t == "" then return nil end
	for _, p in pairs(Players:GetPlayers()) do
		if norm(p.Name) == t or norm(p.DisplayName) == t then
			return p
		end
	end
	return nil
end


local function onTogglePlayer()
	local txt = UI.InputBox.Text
	local target = findPlayerByNameOrDisplay(txt)
	
	if not target then
		warn("Player not found: "..tostring(txt))
		
		local oldColor = UI.InputBox.BackgroundColor3
		UI.InputBox.BackgroundColor3 = C_Error
		task.wait(0.3)
		UI.InputBox.BackgroundColor3 = oldColor
		return
	end
	
	if ESPEnabled[target] then
		ESPEnabled[target] = false
		removeESP(target)
	else
		ESPEnabled[target] = true
		if target.Character then createESP(target) end
	end
	
	UI.InputBox.Text = ""
	updateActiveList()
end


local function setViewAll(on)
	viewAllEnabled = on
	
	
	local targetColor = on and C_Success or C_Error
	local targetPos = on and UDim2.new(1, -23, 0.5, -10) or UDim2.new(0, 3, 0.5, -10)
	
	TweenService:Create(UI.ViewAllSwitch, TweenInfo.new(0.2), {BackgroundColor3 = targetColor}):Play()
	TweenService:Create(UI.ViewAllSwitchKnob, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {Position = targetPos}):Play()
	
	
	if on then
		for _, p in pairs(Players:GetPlayers()) do
			if not (p == LocalPlayer and EXCLUDE_LOCALPLAYER) then
				ESPEnabled[p] = true
				if p.Character then createESP(p) end
			end
		end
	else
		
		
		for p, _ in pairs(ESPEnabled) do
			ESPEnabled[p] = false
			removeESP(p)
		end
	end
	
	updateActiveList()
end


local function unlockUI()
	TweenService:Create(UI.PasswordOverlay, TweenInfo.new(0.3), {BackgroundTransparency = 1}):Play()
	UI.PasswordOverlay:Destroy() 
	UI.MainFrame.Visible = true
end


local function initPasswordModal()
	UI.PassButton.MouseButton1Click:Connect(function()
		if UI.PassBox.Text == PASSWORD then
			unlockUI()
		else
			UI.PassBox.Text = ""
			
			local startPos = UI.PasswordOverlay.Modal.Position
			local tweenInfo = TweenInfo.new(0.06, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, 3, true)
			local tween = TweenService:Create(UI.PasswordOverlay.Modal, tweenInfo, {Position = startPos + UDim2.new(0,6,0,0)})
			tween:Play()
		end
	end)

	UI.PassCancelButton.MouseButton1Click:Connect(function()
		UI.PasswordOverlay.Parent:Destroy() 
	end)

	UI.PassBox.FocusLost:Connect(function(enterPressed)
		if enterPressed then
			UI.PassButton.MouseButton1Click:Invoke()
		end
	end)
	
	UI.GetKeyButton.MouseButton1Click:Connect(function()
		local success = tryCopyToClipboard("https://raw.githubusercontent.com/MegeTech/megeHub-ESP/refs/heads/main/--%20LocalScript%20(1).txt")
		local oldText = UI.GetKeyButton.Text
		if success then
			UI.ModalStatus.Text = "Copied link to clipboard!"
			UI.GetKeyButton.Text = "Copied!"
		else
			UI.ModalStatus.Text = "Failed to copy. Please copy manually: https://raw.githubusercontent.com/MegeTech/megeHub-ESP/refs/heads/main/--%20LocalScript%20(1).txt"
			UI.GetKeyButton.Text = "Failed!"
		end
		
		task.delay(2, function()
			if UI.ModalStatus and UI.ModalStatus.Parent then UI.ModalStatus.Text = "" end
			if UI.GetKeyButton and UI.GetKeyButton.Parent then UI.GetKeyButton.Text = oldText end
		end)
	end)
end


local function initMainPanel()
	
	local dragging, dragStart
	UI.Header.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			local startPos = UI.MainFrame.Position
			
			local moveConn
			moveConn = UserInputService.InputChanged:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
					if dragging then
						local delta = input.Position - dragStart
						UI.MainFrame.Position = UDim2.new(0, startPos.X.Offset + delta.X, 0, startPos.Y.Offset + delta.Y)
					end
				end
			end)
			
			local endConn
			endConn = UserInputService.InputEnded:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
					dragging = false
					if moveConn then moveConn:Disconnect() end
					if endConn then endConn:Disconnect() end
				end
			end)
		end
	end)

	
	local minimized = false
	UI.MinimizeButton.MouseButton1Click:Connect(function()
		minimized = not minimized
		UI.MainContent.Visible = not minimized
		local targetSize = minimized and UDim2.new(PANEL_SIZE.X.Scale, PANEL_SIZE.X.Offset, 0, HEADER_HEIGHT) or PANEL_SIZE
		TweenService:Create(UI.MainFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {Size = targetSize}):Play()
	end)

	
	UI.CloseButton.MouseButton1Click:Connect(function()
		UI.MainFrame.Parent:Destroy()
	end)
	
	
	UI.ToggleButton.MouseButton1Click:Connect(onTogglePlayer)
	UI.InputBox.FocusLost:Connect(function(enterPressed)
		if enterPressed then
			onTogglePlayer()
		end
	end)
	
	UI.ViewAllSwitch.MouseButton1Click:Connect(function()
		setViewAll(not viewAllEnabled)
	end)
end


createGUI()

initPasswordModal()
initMainPanel()


Players.PlayerAdded:Connect(function(p)
	if viewAllEnabled then
		ESPEnabled[p] = true
		
		p.CharacterAdded:Connect(function(char)
			task.wait(0.1) 
			if ESPEnabled[p] then createESP(p) end
		end)
		updateActiveList()
	end
	
	
	p.CharacterAdded:Connect(function(char)
		task.wait(0.1)
		if ESPEnabled[p] then
			removeESP(p) 
			createESP(p)
		end
	end)
end)

Players.PlayerRemoving:Connect(function(p)
	ESPEnabled[p] = nil
	removeESP(p)
	updateActiveList()
end)


for _, p in pairs(Players:GetPlayers()) do
	p.CharacterAdded:Connect(function(char)
		task.wait(0.1)
		if ESPEnabled[p] then
			removeESP(p) 
			createESP(p)
		end
	end)
end


RunService.RenderStepped:Connect(function()
	if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
		
		for p, _ in pairs(ESPs) do removeESP(p) end
		return
	end
	
	local myRoot = LocalPlayer.Character.HumanoidRootPart
	
	for player, data in pairs(ESPs) do
		updateESP(player, data, myRoot.Position)
	end
end)
